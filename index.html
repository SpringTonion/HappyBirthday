<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Happy Birthday</title>
<style>
    * { box-sizing: border-box; }
    body, html {
        margin: 0; padding: 0; width: 100%; height: 100vh;
        background: #ffffff; overflow: hidden;
        font-family: 'Segoe UI', sans-serif;
        transition: background 0.8s ease;
    }

    body.dark-mode { background: #1a0a20; }

    #main-canvas {
        position: relative; width: 100%; height: 100%;
        display: flex; justify-content: center; align-items: center;
    }

    /* ================= HỘP QUÀ ================= */
    .box-container {
        position: absolute; width: 300px; height: 300px;
        cursor: pointer; z-index: 100;
        transition: opacity 1s ease, transform 1s ease;
    }
    .box-base, .box-lid { width: 100%; position: absolute; }
    .box-lid { top: 15px; transition: transform 1.2s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2; }
    .box-base { bottom: 0; z-index: 1; }
    .open .box-lid { transform: translateY(-200px) rotate(-15deg); }
    .fade-out { opacity: 0; transform: scale(0.8); pointer-events: none; }

    /* ================= CỤM QUÀ TRUNG TÂM ================= */
    #surprise {
        position: absolute; 
        display: flex;
        justify-content: center;
        align-items: flex-end; /* Căn chân các món quà bằng nhau */
        gap: 10px;
        z-index: 50;
        pointer-events: none;
    }

    .item {
        opacity: 0; 
        transform: scale(0) translateY(50px);
        transition: opacity 1s ease, transform 1s cubic-bezier(0.34, 1.56, 0.64, 1);
        cursor: pointer; 
        pointer-events: auto;
    }

    .ensure-root { width: 130px; }
    .cake-container { width: 300px; position: relative; }
    .card-root { width: 160px; }
    
    /* Animation cho chai Ensure mới */
    @keyframes popUp {
        0% {
            transform: scale(0);
            opacity: 0;
        }
        60% {
            transform: scale(1.2); /* Phóng to hơn một chút để tạo hiệu ứng nảy */
            opacity: 1;
        }
        100% {
            transform: scale(1); /* Trở về kích thước chuẩn */
            opacity: 1;
        }
    }

    .spawned-ensure {
        position: absolute;
        width: 85px;
        z-index: 5;
        pointer-events: none;
        /* Gắn animation vào đây */
        animation: popUp 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    /* ================= NẾN ĐÈ LÊN BÁNH ================= */
    .candle-wrapper {
        position: absolute;
        /* Vị trí nến trên bánh - chỉnh top để cao/thấp */
        top: 15%;  
        left: 50%;
        transform: translateX(-50%);
        z-index: 5;
        cursor: pointer;
        display: none;
        
        /* TĂNG VÙNG BẤM: Thêm khoảng đệm vô hình xung quanh nến */
        padding: 20px; 
        /* width/height này bao quát cả nến và vùng xung quanh */
    }

    .candle-stick {
        width: 8px; 
        height: 40px; 
        z-index: 6;
        background: linear-gradient(to bottom, #f1a6c9, #fa9cf2);
        margin: 0 auto; 
        border-radius: 2px;
        position: relative; /* Làm mốc cho ngọn lửa */
    }

    .flame {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        top: 0px; 
        z-index: 10; 
        width: 20px; 
        height: 28px; 
        background: #ff9800;
        border-radius: 50% 50% 20% 20%;
        display: none;
        box-shadow: 0 0 25px #ff5722, 0 0 50px #ff9800;
        animation: flicker 0.2s infinite alternate;
    }

    @keyframes flicker { 
        from { transform: translateX(-50%) scale(1) rotate(-1deg); } 
        to { transform: translateX(-50%) scale(1.1) rotate(1deg); } 
    }

    /* ================= OVERLAY THIỆP ================= */
    #overlay {
        position: fixed; inset: 0; 
        background: rgba(15, 0, 25, 0.95);
        display: none; justify-content: center; align-items: center;
        z-index: 1000; opacity: 0;
        transition: opacity 0.8s ease;
        backdrop-filter: blur(15px);
    }

    #overlay.active { opacity: 1; display: flex; }

    .card-content { 
        color: white; text-align: center; padding: 40px;
        max-width: 650px; width: 90%;
        transform: scale(0.5); opacity: 0;
        transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    #overlay.active .card-content { transform: scale(1); opacity: 1; }

    .spawned-ensure { position: absolute; width: 85px; z-index: 5; pointer-events: none; }

    @media(max-width: 600px) {
        .cake-container { width: 160px; }
        .ensure-root { width: 75px; }
        .card-root { width: 85px; }
        .box-container { width: 220px; height: 220px; }
    }
</style>
</head>
<body onclick="handleGlobalClick(event)">

<div id="main-canvas">
    <div class="box-container" id="box" onclick="openBox(event)">
        <img src="box-lid.png" class="box-lid">
        <img src="box-base.png" class="box-base">
    </div>

    <div id="surprise">
        <img src="ensure.png" id="ensure-root" class="item ensure-root" onclick="spawnEnsure(event)">

        <div id="cake-root" class="item cake-container">
            <div class="candle-wrapper" id="candle" onclick="lightCandle(event)">
                <div class="flame" id="flame"></div>
                <div class="candle-stick"></div>
            </div>
            <img src="cake.png" style="width: 100%;">
        </div>

        <img src="card.png" id="card-root" class="item card-root" onclick="openCard(event)">
    </div>
</div>

<div id="overlay" onclick="closeCard()">
    <div class="card-content">
        <h1 style="color: gold; font-size: 3rem;">Happy Birthday! ✨</h1>
        <p style="font-size: 1.3rem; line-height: 1.8;">Chúc mừng sinh nhật bạn! Chúc bạn tuổi mới luôn ngập tràn niềm vui, sức khỏe dồi dào và vạn sự như ý.</p>
        <p style="font-size: 1.1rem; opacity: 0.8;">(Chạm vào bất cứ đâu để đóng thiệp)</p>
    </div>
</div>

<audio id="music" src="music.mp3" loop></audio>

<script>
    const box = document.getElementById('box');
    const music = document.getElementById('music');
    const candle = document.getElementById('candle');
    const flame = document.getElementById('flame');
    const overlay = document.getElementById('overlay');
    const surpriseItems = document.querySelectorAll('.item');

    function openBox(e) {
        e.stopPropagation();
        box.classList.add('open');
        music.play();
        
        // 1. Sau 1.5 giây, bắt đầu cho hộp quà biến mất
        setTimeout(() => {
            box.classList.add('fade-out');
        }, 1500);

        // 2. Ngay khi hộp quà bắt đầu mờ (1.5s - 1.8s), cho các món quà xuất hiện
        setTimeout(() => {
            surpriseItems.forEach(item => {
                item.style.opacity = "1";
                item.style.transform = "scale(1) translateY(0)";
            });
            candle.style.display = "block";
        }, 1800); 

        // 3. Xóa hẳn hộp quà sau khi mờ xong
        setTimeout(() => {
            box.style.display = "none";
        }, 3000);
    }

    function spawnEnsure(e) {
        e.stopPropagation();
        const newEnsure = document.createElement('img');
        newEnsure.src = 'ensure.png';
        newEnsure.className = 'spawned-ensure';
        
        let x, y, collision;
        let attempts = 0;
        
        // Thuật toán tìm vị trí trống
        do {
            collision = false;
            // Giới hạn x, y trong phạm vi màn hình để không bị scrollbar
            x = Math.random() * (window.innerWidth - 100);
            y = Math.random() * (window.innerHeight - 120);
            
            // Kiểm tra va chạm với các vật phẩm chính và các chai đã sinh ra
            const rects = [...document.querySelectorAll('.item, .spawned-ensure')].map(el => el.getBoundingClientRect());
            for (let rect of rects) {
                // Kiểm tra xem vị trí mới (x, y) có đè lên rect cũ không
                if (!(x + 85 < rect.left || x > rect.right || y + 110 < rect.top || y > rect.bottom)) {
                    collision = true;
                    break;
                }
            }
            attempts++;
        } while (collision && attempts < 100);

        newEnsure.style.left = x + 'px';
        newEnsure.style.top = y + 'px';
        
        document.body.appendChild(newEnsure);
    }   

    function lightCandle(e) {
        e.stopPropagation();
        document.body.classList.add('dark-mode');
        flame.style.display = 'block';
    }

    function handleGlobalClick(e) {
        if (document.body.classList.contains('dark-mode')) {
            document.body.classList.remove('dark-mode');
            flame.style.display = 'none';
        }
    }

    function openCard(e) {
        e.stopPropagation();
        overlay.style.display = 'flex';
        setTimeout(() => overlay.classList.add('active'), 50);
    }

    function closeCard() {
        overlay.classList.remove('active');
        setTimeout(() => overlay.style.display = 'none', 800);
    }
</script>
</body>
</html>
